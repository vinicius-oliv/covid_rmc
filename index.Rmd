---
title: "Covid-19 RMC"
output: 
  flexdashboard::flex_dashboard:
    css: style.css
    social: menu    
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, results = "hide")

library(flexdashboard)
library(shiny)
library(geobr)
library(tidyverse)
library(rvest)
library(httr)
library(lubridate)
```

```{r}
#Leitura do banco
casos <- read_csv(file = "covid19_rmc.csv", col_names = T)
```


```{r, cache=T}
#Shapefile Campinas
rmc <- read_metro_area(2018) %>% filter(name_metro == "RM Campinas")

#
no_axis <- theme(axis.title=element_blank(),
                 axis.text=element_blank(),
                 axis.ticks=element_blank())
```
```{r}
#Função para adicionar casos no dia
add_casos <- function(cidades, quant){
  quant <- as.vector(quant)
  cidades <- as.vector(cidades)
  
  casos <- numeric(20)
  rmc <- as.character(rmc$name_muni)
  
  for(i in 1:length(cidades)){
    for(j in 1:length(rmc)){
      if(cidades[i] == rmc[j]){
        casos[j] <- quant[i]
      }
    }
  }
  return(casos)
}

#Função de cálculo do total de casos(dia X(i) +X(i + 1))
calc_total <- function(novo){
  return(novo + casos$Total[(nrow(casos) - 19): nrow(casos)])
}

#
meses <- c("marco", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro")

#Cálculo para os novos casos (dia X(i + 1) - dia X(i))
calc_novos <- function(atual, dia, mes){
    dia_ant = as.integer(dia) - 1
    mes <- ifelse(dia_ant == 0, 
                  as.integer(mes) - 1, 
                  as.integer(mes)
                  )
    
    if(mes < 10){
      mes = paste0("0", mes)
    }
    
    if(dia_ant == 0 & as.integer(mes) %in% c(1, 3, 5, 6, 8, 10)){
      dia_ant = "31"
    }else if(dia_ant == 0){
      dia_ant = "30"
    }else{
    }
  
    ant <- casos %>% 
               filter(Data == dmy(as.integer(paste0(dia_ant, mes, "2020")))) %>% 
               select(Total)
    
    return(atual - ant[["Total"]])                            
}
```


```{r}
data <- as.character(Sys.Date())

mes <- str_split(data, "-")[[1]][2]

#Adiciono o zero na frente por padrão do link
if(as.integer(mes) <= 9){
  mes <- paste0("0", mes)
}
dia <- str_split(data, "-")[[1]][3]

Mes <- meses[as.integer(mes) - 2]

#link da cobertura do G1 Campinas, por enquanto se mantém o padrão
url <- paste0("https://g1.globo.com/sp/campinas-regiao/noticia/2020/", mes, "/", dia,                  "/ultimas-noticias-de-coronavirus-de-",dia, "-de-", Mes,                                        "-na-regiao-de-campinas.ghtml")

texto <- url %>% read_html() %>% html_nodes("ul.content-unordered-list") %>% html_text()

for(i in 1:length(texto)){

  #Garantia de que estou na string contendo as cidades com os casos  
  if(str_detect(texto[i], "Campinas:|Campinas-") == T & 
     str_detect(texto[i], "Valinhos:|Valinhos-") == T){
        cidades <- texto[i]
  }
  
}

#Tratamento da string usando o pacote StringR
casos_cidades <- cidades
cidades <- str_remove_all(cidades, "-.?[[:digit:]]+")
cidades <- str_split(cidades, pattern = " ")[[1]]

if(cidades[1] != "Campinas"){
  cidades <- str_remove_all(casos_cidades, "[[:digit:]]+")
  cidades <- str_split(cidades, pattern = ": ")[[1]]
}

total_casos <- str_extract_all(casos_cidades, "[[:digit:]]+")[[1]]
total_casos <- as.integer(total_casos)

```

```{r}
####### CONF. DE ATUALIZACAO ##########
#Meu app adiciona observações somente às 12h, após esse horário ele apenas atualiza
#Não recomendo mudar para antes das 12h, pois a página do G1 sobe entre 9h ~ 11h
add_obs = F
horario <- as.character(Sys.time())
hora <- str_split(horario, " ")[[1]][2]
hora <- str_split(hora, ":")[[1]][1]
if(as.integer(hora) == 12){
  add_obs = T
}

att <- as.logical(add_obs == F)
```


```{r}
#Adiciono as obs. do dia
if(add_obs){
    atual = add_casos(cidades, total_casos)
    
    dat <-as.integer(paste0(dia, mes,"2020"))
    
    casos <- casos %>% 
      add_row(Data = dmy(dat), 
              Cidade = as.character(rmc$name_muni), 
              Novos = calc_novos(atual, dia, mes), 
              Total = atual)
}
```


```{r}
#Atualizo as obs. do dia
if(att){
  
    atual = add_casos(cidades, total_casos)
    
    t <- casos %>% filter(Data == dmy(as.integer(paste0(dia, mes, "2020")))) %>%  
      select(Total)
    
    if(setequal(t$Total, atual) == F){
      dat <-as.integer(paste0(dia, mes,"2020"))
      casos <- casos %>% filter(Data != dmy(dat))
      casos <- casos %>% 
                add_row(Data = dmy(dat), 
                        Cidade = as.character(rmc$name_muni), 
                        Novos = calc_novos(atual, dia, mes), 
                        Total = atual)
    } 
}
```


Column
-----------------------------------------------------------------------
### Série temporal dos casos

```{r}
#Plot dos casos por data

casos %>% group_by(Cidade) %>% filter(Total != 0) %>% 
  ggplot(aes(x = Data, y = Total, color = Cidade)) +
  geom_line()+
  geom_point() +
  theme_linedraw()+
  scale_color_brewer(type = "qual", palette = "Set1") +
  scale_y_continuous(breaks=seq(0, max(casos$Total), 2), 
                     limits = c(0, max(casos$Total)),
                     minor_breaks = seq(0, max(casos$Total), 1)) +
  scale_x_date(limit=c(dmy(13032020),casos$Data[nrow(casos)] + 2),  
               date_breaks = "2 days",
               date_labels = "%d/%m") +
  labs(title = "Total de casos confirmados de Covid19", subtitle = "Dados: G1 Campinas",
       y = "Casos") +
  theme(axis.title.x =element_blank(), 
        axis.text.x = element_text(angle = 45, vjust = 0.5),
        )
```

Column
-------------------------------------

### Mapa dos casos por cidade

```{r}
#Mapa dos casos por cidade

localizacao <- left_join(rmc, casos, by = c("name_muni" = "Cidade"))

pal <- c("#f6f2cb", "#f9b025","#f98525", "#e76523", "#d44b05")

ultimos_casos <- localizacao %>% filter(Data == dmy(paste0(dia, mes, "2020")))

ggplot(ultimos_casos, aes(text = name_muni)) +
    geom_sf(aes(fill = Total)) +
    geom_sf_text(aes(label = name_muni), size = 2.5) +
    scale_fill_gradientn(limits = c(0, max(ultimos_casos$Total) + 15),
                         breaks = c(min(ultimos_casos$Total), max(ultimos_casos$Total)),
                         labels = c(as.character(min(ultimos_casos$Total)), 
                                    as.character(max(ultimos_casos$Total))),
                         colors = pal, trans = "sqrt",
                         values = c(seq(0, 1, 0.1))) +
    labs(title = "Casos confirmados por cidade", subtitle= "Região metropolitana de Campinas") +
    guides(fill = guide_colorbar(title = "Nº de casos")) +
    theme_void() +
    no_axis
```

```{r}
#Atualizo meu banco de dados
write_csv(casos, path = "covid19_rmc.csv")
```

